<?xml version="1.0" encoding="utf-8"?>
<s:BorderContainer xmlns:fx="http://ns.adobe.com/mxml/2009"
		 xmlns:s="library://ns.adobe.com/flex/spark"
		 xmlns:mx="library://ns.adobe.com/flex/mx"
		 xmlns:local="*"
		 borderVisible="false" backgroundAlpha="0" addedToStage="quizBox_addedToStageHandler(event)" activate="bordercontainer1_activateHandler(event)" deactivate="bordercontainer1_deactivateHandler(event)" xmlns:components="components.*">
	
	<fx:Script>
		<![CDATA[
			import com.alfo.XMLPrefs;
			import com.utils.Console;
			
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			import components.QuizModal;
			
			import events.NavEvent;
			import events.QuizEvent;
			
			import org.osmf.events.TimeEvent;
			
			private var questionsXML:XML;
			private var data:Array;
			private var shuffledQuestions:Array;
			
			private var timo:Timer=new Timer(1000);
			private var conta:Number=1;
			
			private var currentQuestion:Number=0;
			
			private var quizModal:QuizModal;
			
			private var prefs:XMLPrefs = XMLPrefs.getInstance();
			
			protected var minNum:Number=0;
			protected var maxNum:Number;
			protected var randomQuestion:Number;
			
			protected var activeQuestions:Array;
			protected var activeIndex:int = 0;
			
//			RUN FIRST
			protected function quizBox_addedToStageHandler(event:Event):void
			{	
				Console.log("RUN FIRST", this);
				this.addEventListener("QUIZ_DATA_READY", startQuiz);
				
//				readLocalData();
				readRemoteData();
			}
			
			
//			READ DATA IN LOCAL APPLICATION DIRECTORY
			protected function readLocalData():void
			{
				
				trace("path:"+File.applicationDirectory.nativePath);
				var file:File = File.applicationDirectory.resolvePath("assets/xml/questions.xml");
				var fileStream:FileStream = new FileStream();
				fileStream.open(file, FileMode.READ);
				questionsXML = XML(fileStream.readUTFBytes(fileStream.bytesAvailable));
				fileStream.close();
				dispatchEvent( new Event("QUIZ_DATA_READY"));					
			}
			
//			READ DATA FROM SERVER
			protected function readRemoteData():void
			{
				Console.log("readRemoteData", this);
				var header:Object=new Object();
				
//				**header["Accept"] = "application/json";**
					
//				getQuestionaires.contentType = "application/json";
//				getQuestionaires.headers = header;
				getQuestionaires.send();
			}
			
//			HANDLE SERVER RESULTS
			protected function remoteDataSuccess(event:ResultEvent):void
			{
				Console.log("remoteDataSuccess", this);
//				Console.log( event.message, this);
				
				Console.log( event.result, this );
			  
				data = JSON.parse( event.result as String ) as Array;
				Console.log( data, this );
				this.dispatchEvent( new Event("QUIZ_DATA_READY"));
			}
			protected function remoteDataFailed(event:FaultEvent):void
			{
				Console.log("remoteDataFailed", this);
				Console.log( event.message, this);
			}
			
			
			protected function startQuiz(e:Event):void
			{
//				this.removeEventListener("QUIZ_DATA_READY", startQuiz);
				shuffleQuestions();
				
				timo.addEventListener(TimerEvent.TIMER,contatore);
				
				conto.timeLimit=prefs.timeOut;
				quizBox.addEventListener(QuizEvent.CORRECT_ANSWER,correctAnswer);
				quizBox.addEventListener(QuizEvent.WRONG_ANSWER,wrongAnswer);

			}
			
			protected function secondsToMinutesSeconds(secs:Number):String {
				var s:Number = secs % 60;
				var m:Number = Math.floor((secs % 3600 ) /60);
				var h:Number = Math.floor(secs / (60*60));
				
				var minutestring:String = m<10 ? "0"+String(m)+":" : String(m)+":";
				var secstring:String = s<10 ? "0"+String(s) : String(s);
				return minutestring+secstring;
			}
			public function startGame():void {
				conta=0;
				shuffleQuestions();
				conto.timo=0;
				timo.start();
				currentQuestion=0;
				
//				minNum=0;
//				maxNum=questionsXML.clip[currentQuestion].question.length()-1;
//				randomQuestion=Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
				
				pullQuestion();
			}
			protected function pullQuestion():void {

				var dataItem:Object = activeQuestions[ activeIndex ];
				Console.log( dataItem, this ) ;
				if (dataItem!=null)
				{
					questionNum.text = "Question "+(activeIndex+1)+" / "+activeQuestions.length;
					questionText.text= dataItem.question;
					quizBox.makeQuestion(dataItem);
				}
			}
			public function correctAnswer(e:QuizEvent):void {
				randomQuestion=Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
				currentQuestion++;
				trace("dispatched correct");
				showMessage("Correct answer!");
			}
			protected function checkComplete():void {
				if(currentQuestion<(prefs.totalQuestions)) {
					
					pullQuestion();
				} else {
					timo.stop();
					var evento:QuizEvent=new QuizEvent(QuizEvent.QUIZ_COMPLETE,conta);
					dispatchEvent(evento);
					var navigation:NavEvent=new NavEvent(NavEvent.NAVIGATION,"congrat");
					dispatchEvent(navigation);
				}
			}
			public function wrongAnswer(e:QuizEvent):void {
				trace("dispatched wrong");
				showMessage("Wrong answer!","You have "+String(prefs.penalty)+" sec penalty");
				conta+=prefs.penalty;
				conto.timo=conta;
			}
			public function showMessage(line1:String,line2:String=null):void {
				timo.stop();
				quizModal = new QuizModal();
				quizModal.setMessage(line1,line2);
				quizModal.exitFunction = resumeTimer;
				PopUpManager.addPopUp(quizModal, this, true);
				PopUpManager.centerPopUp(quizModal);
				quizModal.y-=100;
				quizModal.x=(1024-quizModal.width)/2;
			}
			public function resumeTimer():void {
				trace("resume timer");
				timo.start();
				checkComplete();
			}
			
			protected function getArrayOfRandomQuestions( n:int ):Array
			{
				var tempdata:Array = [];
				var counter:int = 0;
				if ( data.length<n )
				{
					Console.log("Not enough data in set", this);
					// not enough data for our temp set so will need to re-use existing data
					
					while (tempdata.length<n)
					{
						tempdata.push( data[counter % data.length] );
						counter++;
					}
				} else {
					Console.log("Mixing questions", this);
					// sufficent questions - we can pick and mix
					// This is done by making an array of ids and the splicing it (reducing it to ensure unique questions) as we pick random items.
					var tempIds:Array = [];
					for (var i:Number=0;i<data.length;i++) {
						tempIds[i]=i;
					}
					while (tempdata.length<n)
					{
						tempdata.push( data[ tempIds.splice( Math.round( Math.random() * tempIds.length-1 ), 1) ] )
						counter++;
					}
				}
				
				return tempdata;
				
			}
				
			
			protected function shuffleQuestions():void {
				activeQuestions = getArrayOfRandomQuestions( 5 );
//				for (var i:int=0;i<activeQuestions.length;i++)
//				{
//					Console.log("=============================", this);
//					for (var m:String in activeQuestions[i])
//					{
//						Console.log(m+" "+activeQuestions[i][m], this);
//					}
//				}
//				
			}
			protected function contatore(e:Event):void {
				checkTimeOut();
				conta++;
				conto.timo=conta;
			}
			protected function checkTimeOut():void {
				
				if(conta>=prefs.timeOut) {
					trace("time out!");
					timo.stop();
					var navigation:NavEvent=new NavEvent(NavEvent.NAVIGATION,"loser");
					dispatchEvent(navigation);
				} else {
					var rimasto:Number=prefs.timeOut-conta;
					timeLeft.text="Time left: "+secondsToMinutesSeconds(rimasto);
				}
			}
			protected function bordercontainer1_activateHandler(event:Event):void
			{
				// TODO Auto-generated method stub
				
			}
			
			protected function bordercontainer1_deactivateHandler(event:Event):void
			{
				// TODO Auto-generated method stub
				
			}
			
			

			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
		<!--s:HTTPService id="getQuestionaires" resultFormat="xml" method="GET" url="{this.parentApplication.localURL+'userteam.php'}" result="remoteDataSuccess(event)" fault="remoteDataFailed(event)" /-->
		<s:HTTPService id="getQuestionaires" resultFormat="text" method="GET" url="{'http://192.168.0.4/skyquiz/questions.json'}" result="remoteDataSuccess(event)" fault="remoteDataFailed(event)" />

	</fx:Declarations>
	<s:VGroup width="95%" horizontalAlign="left">
		<s:Spacer height="20"/>
		<s:HGroup width="100%" verticalAlign="bottom">
			<s:VGroup width="50%" horizontalAlign="left">
				<s:Label id="questionNum" width="1000" text="Question X" fontSize="64" fontWeight="bold" color="#91278E" />
			</s:VGroup>
			<s:VGroup width="50%" horizontalAlign="right">
				<local:Contatore id="conto"/>
			</s:VGroup>
		</s:HGroup>
		<s:Spacer height="10"/>
		<s:Label lineHeight="90%" width="1200" fontSize="45" fontWeight="normal" id="questionText" text="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?" />
		<s:Spacer height="10"/>
		<components:QuizBox id="quizBox" />
		<s:Spacer height="10"/>
		<s:Label id="timeLeft" text="Time left: "
					color="#91278E" fontFamily="Sky"
					fontSize="26.25" fontWeight="bold" kerning="on"
					 />
	</s:VGroup>
	
	
</s:BorderContainer>
